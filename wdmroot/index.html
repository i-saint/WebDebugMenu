<!DOCTYPE html>
<html>
<head>
<title>WebDebugMenu</title>

 <style type="text/css">
 .data_children {margin:2px 2px 2px 10px;}
 </style>

<script type="text/javascript" src="prototype.js"></script>
<script type="text/javascript">

var node_data = new Object();
var node_loading = false;
var node_timer;

var create_integer_input = function(type) {
    var i = document.createElement("input");
    i.setAttribute("class", type);
    i.setAttribute("type", "text");
    i.setAttribute("size", 8);
    i.setAttribute("onfocus", "this.lockUpdate=true");
    i.setAttribute("onblur", "this.lockUpdate=false");
    i.setAttribute("onchange", "this.parentNode.notifyChange()");
    var s = document.createElement("span");
    s.appendChild(i);
    s.inputNode = i;
    s.makeReadOnly = function() { this.inputNode.disabled=true; }
    s.notifyChange = function() { this.parentNode.parentNode.notifyChange(); }
    s.setValue = function(v) { if(!this.inputNode.lockUpdate) this.inputNode.value=v.toString(); }
    s.getValue = function() { return parseInt(this.inputNode.value); }
    s.onSlider = function() {
        var p = parseInt(this.slider.value)*0.01;
        var r = this.dataRange;
        var v = Math.floor(r[0]+(r[1]-r[0])*p);
        this.inputNode.value = v.toString();
    }
    s.setRange = function(r) {
        var ri = document.createElement("input");
        ri.setAttribute("type", "range");
        ri.setAttribute("onchange", "this.parentNode.onSlider()");
        ri.setAttribute("onmousedown", "this.parentNode.inputNode.lockUpdate=true");
        ri.setAttribute("onmouseup", "this.parentNode.inputNode.lockUpdate=false;this.parentNode.notifyChange()");
        this.appendChild(ri);
        this.dataRange = r;
        this.slider = ri;
    }
    return s;
}

var create_bool_input = function() {
    var i = document.createElement("input");
    i.setAttribute("class", "bool");
    i.setAttribute("type", "checkbox");
    i.setAttribute("onchange", "this.parentNode.notifyChange()");
    var s = document.createElement("span");
    s.appendChild(i);
    s.inputNode = i;
    s.makeReadOnly = function() { this.inputNode.disabled=true; }
    s.notifyChange = function() { this.parentNode.parentNode.notifyChange(); }
    s.setValue = function(v) { if(!this.inputNode.lockUpdate) this.inputNode.checked=v!=0; }
    s.getValue = function() { return this.inputNode.checked ? 1 : 0; }
    return s;
}

var create_float_input = function(type) {
    var i = document.createElement("input");
    i.setAttribute("class", type);
    i.setAttribute("type", "text");
    i.setAttribute("size", 8);
    i.setAttribute("onfocus", "this.lockUpdate=true");
    i.setAttribute("onblur", "this.lockUpdate=false");
    i.setAttribute("onchange", "this.parentNode.notifyChange()");
    var s = document.createElement("span");
    s.appendChild(i);
    s.inputNode = i;
    s.makeReadOnly = function() { this.inputNode.disabled=true; }
    s.notifyChange = function() { this.parentNode.parentNode.notifyChange(); }
    s.setValue = function(v) { if(!this.inputNode.lockUpdate) this.inputNode.value=v.toString(); }
    s.getValue = function() { return parseFloat(this.inputNode.value); }
    s.onSlider = function() {
        var p = parseInt(this.slider.value)*0.01;
        var r = this.dataRange;
        var v = r[0]+(r[1]-r[0])*p;
        this.inputNode.value = v.toString();
    }
    s.setRange = function(r) {
        var ri = document.createElement("input");
        ri.setAttribute("type", "range");
        ri.setAttribute("onchange", "this.parentNode.onSlider()");
        ri.setAttribute("onmousedown", "this.parentNode.inputNode.lockUpdate=true");
        ri.setAttribute("onmouseup", "this.parentNode.inputNode.lockUpdate=false;this.parentNode.notifyChange()");
        this.appendChild(ri);
        this.dataRange = r;
        this.slider = ri;
    }
    return s;
}

var DataInputCreators = {
    "int8":  function() { return create_integer_input("int8") },
    "int16": function() { return create_integer_input("int16") },
    "int32": function() { return create_integer_input("int32") },
    "uint8": function() { return create_integer_input("uint8") },
    "uint16":function() { return create_integer_input("uint16") },
    "uint32":function() { return create_integer_input("uint32") },
    "bool": create_bool_input,
    "float32": function() { return create_float_input("float32") },
    "float64": function() { return create_float_input("float64") },
}


var create_integer_control = function(type)
{
    var d = document.createElement("span");
    d.setAttribute("class", type);
    d.appendChild(DataInputCreators[type]());
    d.setValue = function(v) { this.children[0].setValue(v); }
    d.getValue = function() { return this.children[0].getValue(); }
    d.setRange = function(r) { this.children[0].setRange(r); };
    d.makeReadOnly = function() { this.children[0].makeReadOnly(); }
    return d;
}

var create_bool_control = function()
{
    var d = document.createElement("span");
    d.setAttribute("class", "bool");
    d.appendChild(DataInputCreators.bool());
    d.setValue = function(v) { this.children[0].setValue(v); }
    d.getValue = function() { return this.children[0].getValue(); }
    d.makeReadOnly = function() { this.children[0].makeReadOnly(); }
    return d;
}

var create_float_control = function(type)
{
    var d = document.createElement("span");
    d.setAttribute("class", "float32");
    d.appendChild(DataInputCreators.float32());
    d.setValue = function(v) { this.children[0].setValue(v); }
    d.getValue = function() { return this.children[0].getValue(); }
    d.setRange = function(r) { this.children[0].setRange(r); };
    d.makeReadOnly = function() { this.children[0].makeReadOnly(); }
    return d;
}

var DataControlCreators = {
    "int8":  function() { return create_integer_control("int8"); },
    "int16": function() { return create_integer_control("int16"); },
    "int32": function() { return create_integer_control("int32"); },
    "uint8": function() { return create_integer_control("uint8"); },
    "uint16":function() { return create_integer_control("uint16"); },
    "uint32":function() { return create_integer_control("uint32"); },
    "bool": create_bool_control,
    "float32": function() { return create_float_control("float32"); },
    "float64": function() { return create_float_control("float32"); },

    "int32x2": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "int32x2");
        d.appendChild(DataInputCreators.int32());
        d.appendChild(DataInputCreators.int32());
        d.setValue = function(v) {
            this.children[0].setValue(v[0]);
            this.children[1].setValue(v[1]);
        }
        d.getValue = function() {
            return "["+
            this.children[0].getValue()+","+
            this.children[1].getValue()+
            "]";
        }
        return d;
    },
    "int32x3": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "int32x3");
        d.appendChild(DataInputCreators.int32());
        d.appendChild(DataInputCreators.int32());
        d.appendChild(DataInputCreators.int32());
        d.setValue = function(v) {
            this.children[0].setValue(v[0]);
            this.children[1].setValue(v[1]);
            this.children[2].setValue(v[2]);
        }
        d.getValue = function() {
            return "["+
            this.children[0].getValue()+","+
            this.children[1].getValue()+","+
            this.children[2].getValue()+
            "]";
        }
        return d;
    },
    "int32x4": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "int32x4");
        d.appendChild(DataInputCreators.int32());
        d.appendChild(DataInputCreators.int32());
        d.appendChild(DataInputCreators.int32());
        d.appendChild(DataInputCreators.int32());
        d.setValue = function(v) {
            this.children[0].setValue(v[0]);
            this.children[1].setValue(v[1]);
            this.children[2].setValue(v[2]);
            this.children[3].setValue(v[3]);
        }
        d.getValue = function() {
            return "["+
            this.children[0].getValue()+","+
            this.children[1].getValue()+","+
            this.children[2].getValue()+","+
            this.children[3].getValue()+
            "]";
        }
        return d;
    },


    "float32x2": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "float32x2");
        d.appendChild(DataInputCreators.float32());
        d.appendChild(DataInputCreators.float32());
        d.setValue = function(v) {
            this.children[0].setValue(v[0]);
            this.children[1].setValue(v[1]);
        }
        d.getValue = function() {
            return "["+
            this.children[0].getValue()+","+
            this.children[1].getValue()+
            "]";
        }
        return d;
    },
    "float32x3": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "float32x3");
        d.appendChild(DataInputCreators.float32());
        d.appendChild(DataInputCreators.float32());
        d.appendChild(DataInputCreators.float32());
        d.setValue = function(v) {
            this.children[0].setValue(v[0]);
            this.children[1].setValue(v[1]);
            this.children[2].setValue(v[2]);
        }
        d.getValue = function() {
            return "["+
            this.children[0].getValue()+","+
            this.children[1].getValue()+","+
            this.children[2].getValue()+
            "]";
        }
        return d;
    },
    "float32x4": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "float32x4");
        d.appendChild(DataInputCreators.float32());
        d.appendChild(DataInputCreators.float32());
        d.appendChild(DataInputCreators.float32());
        d.appendChild(DataInputCreators.float32());
        d.setValue = function(v) {
            this.children[0].setValue(v[0]);
            this.children[1].setValue(v[1]);
            this.children[2].setValue(v[2]);
            this.children[3].setValue(v[3]);
        }
        d.getValue = function() {
            return "["+
            this.children[0].getValue()+","+
            this.children[1].getValue()+","+
            this.children[2].getValue()+","+
            this.children[3].getValue()+
            "]";
        }
        return d;
    },

    //"float32x2x2":createFloatControl,
    //"float32x3x3":createFloatControl,
    //"float32x4x3":createFloatControl,
    //"float32x4x4":createFloatControl,
}

function getOrCreateNode(parent, data)
{
    var node = $("node"+data.id);
    if(node!=null && node.nodeID!=data.id) {
        node.parentNode.removeChild(node);
        node = null;
    }

    if(node==null) {
        node = document.createElement("div");
        node.nodeID = data.id;
        node.notifyChange = function() { handleChange(this.nodeID); }
        node.setAttribute("class", "data_cell");
        node.setAttribute("id", "node"+data.id);

        if(data.name!="" && data.children.length>0) {
            var cross = document.createElement("span");
            cross.setAttribute("id", "cross"+data.id);
            cross.setAttribute("cross", "cross");
            cross.setAttribute("onclick", "toggleVisibility("+data.id+")");
            cross.appendChild(document.createTextNode("-"));
            node.appendChild(cross);
            node.toggleNode = cross;
        }

        var name = document.createElement("span");
        name.appendChild(document.createTextNode(data.name));
        node.appendChild(name);

        if(data.type!=null) {
            var dataType = document.createElement("span");
            dataType.appendChild(document.createTextNode("("+data.type+")"));
            node.appendChild(dataType);

            var inp = DataControlCreators[data.type]();
            inp.setAttribute("id", "data"+data.id);
            if(data.range) { inp.setRange(data.range); }
            if(data.readonly) { inp.makeReadOnly(); }
            node.appendChild(inp);
            node.dataNode = inp;
        }
        if(data.callable) {
            var button = document.createElement("input");
            button.setAttribute("type", "button");
            button.setAttribute("onclick", "handleCall("+data.id+")");
            button.setAttribute("value", "call");
            node.appendChild(button);
        }

        children = document.createElement("div");
        children.setAttribute("class", "data_children");
        children.setAttribute("id", "children"+data.id);
        node.appendChild(children);
        node.dataChildren = children;
        parent.appendChild(node);
    }
    if(node.dataNode && data.value) {
        node.dataNode.setValue(data.value);
    }
    return node;
}

function updateDataGrid(div, data, depth)
{
    var node = getOrCreateNode(div, data);
    node.updated = true;
    for(var i=0; i<data.children.length; ++i) {
        updateDataGrid(node.dataChildren, data.children[i], depth+1);
    }
}

function beforeUpdateData(node)
{
    if(node==null) { return; }
    if(node.dataChildren) {
        node.updated = false;
        var children = node.dataChildren.children;
        for(var i=0; i<children.length; ++i) {
            beforeUpdateData(children[i]);
        }
    }
}

function afterUpdateData(node)
{
    if(node==null) { return; }
    if(node.updated==false) {
        node.parentNode.removeChild(node);
    }
    else {
        var children = node.dataChildren.children;
        for(var i=0; i<children.length; ++i) {
            afterUpdateData(children[i]);
        }
    }
}

function updateNodeData()
{
    if(node_loading) { return; }

    node_loading = true;
    var ajax = new Ajax.Request("/data",
    {
        method: "get",
        onComplete: function(res) {
            node_loading = false;
            node_data = res.responseText.evalJSON();
            var data_root = $("data_grid");
            beforeUpdateData(data_root.children[0]);
            updateDataGrid(data_root, node_data, 0);
            afterUpdateData(data_root.children[0]);
        }
    });

}

function toggleVisibility(id)
{
    var children = $("node"+id).lastChild;
    var cross = $("cross"+id);
    if(children.style.display=="") {
        children.style.display = "none";
        cross.innerText = "+";
    }
    else {
        children.style.display = "";
        cross.innerText = "-";
    }
}

function handleChange(id)
{
    postCommand(id.toString()+"->set(" + $("data"+id).getValue() + ")");
}

function handleCall(id)
{
    postCommand(id.toString()+"->call()");
}

function postCommand(values)
{
    var ajax = new Ajax.Request("/command",
    {
        method: "post",
        parameters: "command="+values,
        onComplete: function(res) {
        }
    });
}

function onLoad()
{
    updateNodeData();
    clearInterval(node_timer);
    node_timer = setInterval(updateNodeData, 3000);
}
</script>
</head>

<body onload="onLoad()">
    <div id="data_grid"></div>
</body>

</html>
