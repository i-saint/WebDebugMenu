<!DOCTYPE html>
<html>
<head>
<title>WebDebugMenu</title>

 <style type="text/css">
 .data_children {margin:2px 2px 2px 10px;}
 </style>

<script type="text/javascript" src="prototype.js"></script>
<script type="text/javascript">

var node_data = new Object();
var node_loading = false;
var node_timer;


var createInputFuncs = {
    "int8": function(){
        var i = document.createElement("input");
        i.setAttribute("class", "int8");
        i.setAttribute("type", "text");
        i.setAttribute("size", 4);
        i.setValue = function(v) { this.value = v.toString(); }
        i.getValue = function() { return this.value; }
        return i;
    },
    "int16": function(){
        var i = document.createElement("input");
        i.setAttribute("class", "int16");
        i.setAttribute("type", "text");
        i.setAttribute("size", 6);
        i.setValue = function(v) { this.value = v.toString(); }
        i.getValue = function() { return this.value; }
        return i;
    },
    "int32": function(){
        var i = document.createElement("input");
        i.setAttribute("class", "int32");
        i.setAttribute("type", "text");
        i.setAttribute("size", 10);
        i.setValue = function(v) { this.value = v.toString(); }
        i.getValue = function() { return this.value; }
        return i;
    },

    "uint8": function(){
        var i = document.createElement("input");
        i.setAttribute("class", "uint8");
        i.setAttribute("type", "text");
        i.setAttribute("size", 4);
        i.setValue = function(v) { this.value = v.toString(); }
        i.getValue = function() { return this.value; }
        return i;
    },
    "uint16": function(){
        var i = document.createElement("input");
        i.setAttribute("class", "uint16");
        i.setAttribute("type", "text");
        i.setAttribute("size", 6);
        i.setValue = function(v) { this.value = v.toString(); }
        i.getValue = function() { return this.value; }
        return i;
    },
    "uint32": function(){
        var i = document.createElement("input");
        i.setAttribute("class", "uint32");
        i.setAttribute("type", "text");
        i.setAttribute("size", 10);
        i.setValue = function(v) { this.value = v.toString(); }
        i.getValue = function() { return this.value; }
        return i;
    },

    "bool": function(){
        var i = document.createElement("input");
        i.setAttribute("class", "bool");
        i.setAttribute("type", "checkbox");
        i.setValue = function(v) { this.checked = v!=0; }
        i.getValue = function() { return this.checked ? 1 : 0; }
        return i;
    },

    "float32": function(){
        var i = document.createElement("input");
        i.setAttribute("class", "float32");
        i.setAttribute("type", "text");
        i.setAttribute("size", 10);
        i.setValue = function(v) { this.value = v.toString(); }
        i.getValue = function() { return this.value; }
        return i;
    },
    "float64": function(){
        var i = document.createElement("input");
        i.setAttribute("class", "float64");
        i.setAttribute("type", "text");
        i.setAttribute("size", 10);
        i.setValue = function(v) { this.value = v.toString(); }
        i.getValue = function() { return this.value; }
        return i;
    },
}

var createControlFuncs = {
    "int8": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "int8");
        d.appendChild(createInputFuncs.int8());
        d.setValue = function(v) { this.children[0].setValue(v); }
        d.getValue = function() { return this.children[0].getValue(); }
        return d;
    },
    "int16": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "int16");
        d.appendChild(createInputFuncs.int16());
        d.setValue = function(v) { this.children[0].setValue(v); }
        d.getValue = function() { return this.children[0].getValue(); }
        return d;
    },
    "int32": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "int32");
        d.appendChild(createInputFuncs.int32());
        d.setValue = function(v) { this.children[0].setValue(v); }
        d.getValue = function() { return this.children[0].getValue(); }
        return d;
    },


    "uint8": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "uint8");
        d.appendChild(createInputFuncs.uint8());
        d.setValue = function(v) { this.children[0].setValue(v); }
        d.getValue = function() { return this.children[0].getValue(); }
        return d;
    },
    "uint16": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "uint16");
        d.appendChild(createInputFuncs.uint16());
        d.setValue = function(v) { this.children[0].setValue(v); }
        d.getValue = function() { return this.children[0].getValue(); }
        return d;
    },
    "uint32": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "uint32");
        d.appendChild(createInputFuncs.uint32());
        d.setValue = function(v) { this.children[0].setValue(v); }
        d.getValue = function() { return this.children[0].getValue(); }
        return d;
    },

    "bool": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "bool");
        d.appendChild(createInputFuncs.bool());
        d.setValue = function(v) { this.children[0].setValue(v); }
        d.getValue = function() { return this.children[0].getValue(); }
        return d;
    },

    "float32": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "float32");
        d.appendChild(createInputFuncs.float32());
        d.setValue = function(v) { this.children[0].setValue(v); }
        d.getValue = function() { return this.children[0].getValue(); }
        return d;
    },
    "float64": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "float64");
        d.appendChild(createInputFuncs.float64());
        d.setValue = function(v) { this.children[0].setValue(v); }
        d.getValue = function() { return this.children[0].getValue(); }
        return d;
    },


    "int32x2": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "int32x2");
        d.appendChild(createInputFuncs.int32());
        d.appendChild(createInputFuncs.int32());
        d.setValue = function(v) {
            this.children[0].setValue(v[0]);
            this.children[1].setValue(v[1]);
        }
        d.getValue = function() {
            return "["+
            this.children[0].getValue()+","+
            this.children[1].getValue()+
            "]";
        }
        return d;
    },
    "int32x3": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "int32x3");
        d.appendChild(createInputFuncs.int32());
        d.appendChild(createInputFuncs.int32());
        d.appendChild(createInputFuncs.int32());
        d.setValue = function(v) {
            this.children[0].setValue(v[0]);
            this.children[1].setValue(v[1]);
            this.children[2].setValue(v[2]);
        }
        d.getValue = function() {
            return "["+
            this.children[0].getValue()+","+
            this.children[1].getValue()+","+
            this.children[2].getValue()+
            "]";
        }
        return d;
    },
    "int32x4": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "int32x4");
        d.appendChild(createInputFuncs.int32());
        d.appendChild(createInputFuncs.int32());
        d.appendChild(createInputFuncs.int32());
        d.appendChild(createInputFuncs.int32());
        d.setValue = function(v) {
            this.children[0].setValue(v[0]);
            this.children[1].setValue(v[1]);
            this.children[2].setValue(v[2]);
            this.children[3].setValue(v[3]);
        }
        d.getValue = function() {
            return "["+
            this.children[0].getValue()+","+
            this.children[1].getValue()+","+
            this.children[2].getValue()+","+
            this.children[3].getValue()+
            "]";
        }
        return d;
    },


    "float32x2": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "float32x2");
        d.appendChild(createInputFuncs.float32());
        d.appendChild(createInputFuncs.float32());
        d.setValue = function(v) {
            this.children[0].setValue(v[0]);
            this.children[1].setValue(v[1]);
        }
        d.getValue = function() {
            return "["+
            this.children[0].getValue()+","+
            this.children[1].getValue()+
            "]";
        }
        return d;
    },
    "float32x3": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "float32x3");
        d.appendChild(createInputFuncs.float32());
        d.appendChild(createInputFuncs.float32());
        d.appendChild(createInputFuncs.float32());
        d.setValue = function(v) {
            this.children[0].setValue(v[0]);
            this.children[1].setValue(v[1]);
            this.children[2].setValue(v[2]);
        }
        d.getValue = function() {
            return "["+
            this.children[0].getValue()+","+
            this.children[1].getValue()+","+
            this.children[2].getValue()+
            "]";
        }
        return d;
    },
    "float32x4": function() {
        var d = document.createElement("span");
        d.setAttribute("class", "float32x4");
        d.appendChild(createInputFuncs.float32());
        d.appendChild(createInputFuncs.float32());
        d.appendChild(createInputFuncs.float32());
        d.appendChild(createInputFuncs.float32());
        d.setValue = function(v) {
            this.children[0].setValue(v[0]);
            this.children[1].setValue(v[1]);
            this.children[2].setValue(v[2]);
            this.children[3].setValue(v[3]);
        }
        d.getValue = function() {
            return "["+
            this.children[0].getValue()+","+
            this.children[1].getValue()+","+
            this.children[2].getValue()+","+
            this.children[3].getValue()+
            "]";
        }
        return d;
    },

    //"float32x2x2":createFloatControl,
    //"float32x3x3":createFloatControl,
    //"float32x4x3":createFloatControl,
    //"float32x4x4":createFloatControl,
}
function getOrCreateNode(div, data)
{
    var node = $("node"+data.id);
    if(node==null) {
        node = document.createElement("div");
        node.setAttribute("class", "data_cell");
        node.setAttribute("id", "node"+data.id);
        div.appendChild(node);

        if(data.name!="" && data.children.length>0) {
            var cross = document.createElement("span");
            cross.setAttribute("id", "cross"+data.id);
            cross.setAttribute("cross", "cross");
            cross.setAttribute("onclick", "toggleVisibility("+data.id+")");
            cross.appendChild(document.createTextNode("-"));
            node.appendChild(cross);
        }

        var name = document.createElement("span");
        name.appendChild(document.createTextNode(data.name));
        node.appendChild(name);

        if(data.type!=null) {
            var dataType = document.createElement("span");
            dataType.setAttribute("id", "dataType"+data.id);
            dataType.appendChild(document.createTextNode("("+data.type+")"));
            node.appendChild(dataType);

            var inp = createControlFuncs[data.type]();
            inp.setAttribute("id", "data"+data.id);
            for(var i=0; i<inp.children.length; ++i) {
                inp.children[i].setAttribute("onchange", "handleChange("+data.id+")");
            }
            node.appendChild(inp);
            node.dataNode = inp;
        }
        if(data.callable) {
            var button = document.createElement("input");
            button.setAttribute("type", "button");
            button.setAttribute("onclick", "handleCall("+data.id+")");
            button.setAttribute("value", "call");
            node.appendChild(button);
        }

        children = document.createElement("div");
        children.setAttribute("class", "data_children");
        children.setAttribute("id", "children"+data.id);
        node.appendChild(children);
    }
    if(node.dataNode && data.value) {
        node.dataNode.setValue(data.value);
    }
    return node;
}

function updateDataGrid(div, data, depth)
{
    var node = getOrCreateNode(div, data);
    for(var i=0; i<data.children.length; ++i) {
        updateDataGrid(node.lastChild, data.children[i], depth+1);
    }
}

function updateNodeData()
{
    if(node_loading) { return; }

    node_loading = true;
    var ajax = new Ajax.Request("/data",
    {
        method: "get",
        onComplete: function(res) {
            node_loading = false;
            node_data = res.responseText.evalJSON();
            updateDataGrid($("data_grid"), node_data, 0);
        }
    });

}

function toggleVisibility(id)
{
    var children = $("node"+id).lastChild;
    var cross = $("cross"+id);
    if(children.style.display=="") {
        children.style.display = "none";
        cross.innerText = "+";
    }
    else {
        children.style.display = "";
        cross.innerText = "-";
    }
}

function handleChange(id)
{
    postCommand(id.toString()+"->set(" + $("data"+id).getValue() + ")");
}

function handleCall(id)
{
    postCommand(id.toString()+"->call()");
}

function postCommand(values)
{
    var ajax = new Ajax.Request("/command",
    {
        method: "post",
        parameters: "command="+values,
        onComplete: function(res) {
        }
    });
}

function onLoad()
{
    updateNodeData();
    clearInterval(node_timer);
    node_timer = setInterval(updateNodeData, 3000);
}
</script>
</head>

<body onload="onLoad()">
    <div id="data_grid"></div>
</body>

</html>
