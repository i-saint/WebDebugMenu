<!DOCTYPE html>
<html>
<head>
<title>WebDebugMenu</title>

 <style type="text/css">
 .data_children {margin:2px 2px 2px 10px;}
 </style>

<script type="text/javascript" src="prototype.js"></script>
<script type="text/javascript">

var node_data = new Object();
var node_loading = false;
var node_timer;


function createIntControl(div, data)
{
    var i = document.createElement("input");
    i.setAttribute("type", "text");
    i.setAttribute("value", data.value.toString());
    div.appendChild(i);
    return i;
}

function createBoolControl(div, data)
{
    var i = document.createElement("input");
    i.setAttribute("type", "checkbox");
    if(data.value!=0) {
        i.setAttribute("checked", true);
    }
    div.appendChild(i);
    return i;
}

function createFloatControl(div, data)
{
    var i = document.createElement("input");
    i.setAttribute("type", "text");
    i.setAttribute("value", data.value.toString());
    div.appendChild(i);
    return i;
}

var createControlFuncs = {
    "int8":   createIntControl,
    "int16":  createIntControl,
    "int32":  createIntControl,
    "uint8":  createIntControl,
    "uint16": createIntControl,
    "uint32": createIntControl,
    "bool":   createBoolControl,
    "float32":createFloatControl,
    "float64":createFloatControl,
}
function getOrCreateNode(div, data)
{
    var node = $("node"+data.id);
    if(node==null) {
        node = document.createElement("div");
        node.setAttribute("class", "data_cell");
        node.setAttribute("id", "node"+data.id);
        div.appendChild(node);

        if(data.name!="" && data.children.length>0) {
            var cross = document.createElement("span");
            cross.setAttribute("id", "cross"+data.id);
            cross.setAttribute("cross", "cross");
            cross.setAttribute("onclick", "toggleVisibility("+data.id+")");
            cross.appendChild(document.createTextNode("-"));
            node.appendChild(cross);
        }

        var name = document.createElement("span");
        name.appendChild(document.createTextNode(data.name));
        node.appendChild(name);

        if(data.type!=null) {
            var dataType = document.createElement("span");
            dataType.setAttribute("id", "dataType"+data.id);
            dataType.appendChild(document.createTextNode("("+data.type+")"));
            node.appendChild(dataType);

            var inp = createControlFuncs[data.type](node, data);
            inp.setAttribute("id", "data"+data.id);
            inp.setAttribute("onchange", "handleChange("+data.id+")");
        }

        children = document.createElement("div");
        children.setAttribute("class", "data_children");
        children.setAttribute("id", "children"+data.id);
        node.appendChild(children);
    }
    return node;
}

function updateDataGrid(div, data, depth)
{
    var node = getOrCreateNode(div, data);
    for(var i=0; i<data.children.length; ++i) {
        updateDataGrid(node.lastChild, data.children[i], depth+1);
    }
}

function updateNodeData()
{
    if(node_loading) { return; }

    node_loading = true;
    var ajax = new Ajax.Request("/data",
    {
        method: "get",
        onComplete: function(res) {
            node_loading = false;
            node_data = res.responseText.evalJSON();
            updateDataGrid($("data_grid"), node_data, 0);
        }
    });

}

function toggleVisibility(id)
{
    var children = $("node"+id).lastChild;
    var cross = $("cross"+id);
    if(children.style.display=="") {
        children.style.display = "none";
        cross.innerText = "+";
    }
    else {
        children.style.display = "";
        cross.innerText = "-";
    }
}

function handleChange(id)
{
    var data = $("data"+id);
    var value;
    if(data.type=="checkbox") {
        value = data.checked ? 1 : 0;
    }
    else {
        value = data.value;
    }
    postCommand(id.toString()+"->set("+value+")");
}

function postCommand(values)
{
    var ajax = new Ajax.Request("/command",
    {
        method: "post",
        parameters: "command="+values,
        onComplete: function(res) {
        }
    });
}

function onLoad()
{
    updateNodeData();
    clearInterval(node_timer);
    node_timer = setInterval(updateNodeData, 3000);
}
</script>
</head>

<body onload="onLoad()">
    <div id="data_grid"></div>
</body>

</html>
